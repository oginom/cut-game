# Phase 4: UI画面の実装 - 詳細実装計画

## 概要

Phase 4では、ゲームの全体的なフローを完成させるためのUI画面を実装します。タイトル画面、セットアップ画面、設定画面、リザルト画面の4つの画面と、それらを統括するGameStateManagerを作成します。

## 目標

- タイトル画面の実装
- セットアップ画面の実装（トラッキング初期化待機）
- 設定画面の実装（カメラON/OFF、顔表示ON/OFF）
- リザルト画面の実装（スコア表示、リプレイ）
- 画面遷移の管理

## Step 4.1: GameStateManagerとタイトル画面の実装

### 目的

ゲーム全体の状態管理を行うGameStateManagerを実装し、最初の画面としてタイトル画面を作成します。

### タスク詳細

1. **型定義ファイルの作成**
   - `src/types/ui.ts`を作成
   - `GameState`: ゲームの状態（title, setup, settings, playing, result）
   - `GameSettings`: ゲーム設定（カメラON/OFF、顔表示ON/OFF）
   - `ScreenCallbacks`: 各画面のコールバック定義

2. **GameStateManagerの実装**
   - `src/components/ui/GameStateManager.ts`を作成
   - 実装する機能:
     - `init()`: 状態管理の初期化
     - `setState()`: 状態の変更と画面の切り替え
     - `getState()`: 現在の状態取得
     - `getSettings()`: 設定の取得
     - `updateSettings()`: 設定の更新
     - `loadSettings()`: localStorageから設定読み込み
     - `saveSettings()`: localStorageに設定保存
   - 画面遷移の管理:
     - 各画面のshow/hideを制御
     - 状態に応じてゲームの開始/停止を制御

3. **TitleScreenの実装**
   - `src/components/ui/TitleScreen.ts`を作成
   - 実装する機能:
     - `init()`: タイトル画面の作成
     - `show()`: 画面を表示
     - `hide()`: 画面を非表示
     - `dispose()`: クリーンアップ
   - UI要素:
     - ゲームタイトル「新春カニカニパニック!」
     - カメラ許可に関する注意事項
     - スタートボタン（セットアップ画面へ遷移）
     - 設定ボタン（設定画面へ遷移）
   - スタイリング:
     - 中央配置
     - 和風のデザイン
     - レスポンシブ対応

4. **main.tsの更新**
   - GameStateManagerを導入
   - 初期状態をtitleに設定
   - TitleScreenの初期化と表示
   - ゲーム機能は画面遷移に応じて初期化するよう変更

5. **CSSの追加**
   - `src/style.css`にUI画面用のスタイルを追加
   - 共通スタイル（ボタン、コンテナ等）
   - タイトル画面専用スタイル

### 完了条件

- [x] `src/types/ui.ts`が作成され、必要な型が定義されている
- [x] `src/components/ui/GameStateManager.ts`が実装されている
- [x] `src/components/ui/TitleScreen.ts`が実装されている
- [x] タイトル画面が表示される
- [x] スタートボタンで次の画面へ遷移できる
- [x] 設定ボタンで設定画面へ遷移できる（Step 4.3で実装）
- [x] TypeScriptコンパイルエラーがない
- [x] ビルドが成功する

### 検証方法

1. `pnpm run dev`でアプリを起動
2. ブラウザで画面を開く
3. タイトル画面が表示される
4. 「新春カニカニパニック!」のタイトルが見える
5. カメラ許可に関する注意事項が表示される
6. スタートボタンをクリックすると次の画面へ遷移する
7. 設定ボタンが表示される（機能はStep 4.3で実装）

---

## Step 4.2: セットアップ画面の実装

### 目的

トラッキングの初期化を行い、準備が整ったらゲームを開始できるようにします。

### タスク詳細

1. **SetupScreenの実装**
   - `src/components/ui/SetupScreen.ts`を作成
   - 実装する機能:
     - `init()`: セットアップ画面の作成
     - `show()`: 画面を表示
     - `hide()`: 画面を非表示
     - `setStatus()`: ステータスメッセージの更新
     - `setProgress()`: 進捗状況の更新（0-100%）
     - `dispose()`: クリーンアップ
   - UI要素:
     - タイトル「準備中...」
     - ステータスメッセージ表示エリア
     - プログレスバー（またはローディングアニメーション）
     - 注意事項（手をカメラに映す等）
     - タイトルに戻るボタン
   - スタイリング:
     - 中央配置
     - 進捗が分かりやすいデザイン

2. **GameStateManagerの更新**
   - `setState('setup')`時の処理を追加
   - SetupScreenの表示
   - カメラとトラッキングの初期化を開始
   - 初期化の進捗をSetupScreenに通知

3. **main.tsの更新**
   - セットアップ画面での初期化処理:
     - カメラの起動
     - トラッキングの初期化（CameraView、TrackingManager）
     - 各段階でステータスメッセージを更新
   - 初期化完了時の処理:
     - 自動的にplaying状態へ遷移
     - ゲームを開始（GameManager、Scene等）

4. **エラーハンドリング**
   - カメラアクセス失敗時のエラー表示
   - タイトル画面に戻れるようにする

5. **CSSの追加**
   - セットアップ画面専用スタイル
   - プログレスバーのスタイル

### 完了条件

- [x] `src/components/ui/SetupScreen.ts`が実装されている
- [x] セットアップ画面が表示される
- [x] カメラとトラッキングの初期化が実行される
- [x] 初期化の進捗がリアルタイムで表示される
- [x] 初期化完了後、自動的にゲームが開始される
- [x] エラー時にタイトル画面に戻れる
- [x] TypeScriptコンパイルエラーがない
- [x] ビルドが成功する

### 検証方法

1. `pnpm run dev`でアプリを起動
2. タイトル画面でスタートボタンをクリック
3. セットアップ画面が表示される
4. 「カメラを起動中...」等のメッセージが表示される
5. プログレスバーが進行する
6. カメラ許可を求められる
7. カメラ許可後、「トラッキングを初期化中...」と表示される
8. 初期化が完了すると自動的にゲーム画面へ遷移する
9. カメラ拒否時はエラーメッセージが表示され、タイトルに戻れる

---

## Step 4.3: 設定画面の実装

### 目的

カメラON/OFF、顔表示ON/OFFの設定を行えるようにします。

### タスク詳細

1. **SettingsScreenの実装**
   - `src/components/ui/SettingsScreen.ts`を作成
   - 実装する機能:
     - `init()`: 設定画面の作成
     - `show()`: 画面を表示
     - `hide()`: 画面を非表示
     - `loadSettings()`: 現在の設定を画面に反映
     - `dispose()`: クリーンアップ
   - UI要素:
     - タイトル「設定」
     - カメラON/OFFトグル
     - 顔表示ON/OFFトグル（カメラON時のみ有効）
     - 各設定の説明文
     - 保存して戻るボタン
     - キャンセルボタン
   - スタイリング:
     - 中央配置
     - トグルスイッチのデザイン
     - 設定項目の説明文

2. **GameStateManagerの更新**
   - `setState('settings')`時の処理を追加
   - SettingsScreenの表示
   - 設定変更の保存処理
   - タイトル画面またはセットアップ画面に戻る処理

3. **設定の適用**
   - カメラOFF時:
     - カメラ映像を非表示
     - キャラクター画像を背景に表示
     - トラッキングは実行しない
     - ロープ切断はクリックのみ
   - カメラON時:
     - カメラ映像を背景に表示
     - トラッキングを実行
     - ジェスチャー操作が有効
   - 顔表示OFF時（カメラON時のみ）:
     - フェイストラッキング位置にキャラクター顔を表示
   - 顔表示ON時:
     - キャラクター顔を非表示（実際のカメラ映像を表示）

4. **TitleScreenの更新**
   - 設定ボタンのクリックイベントを実装
   - 設定画面への遷移

5. **CSSの追加**
   - 設定画面専用スタイル
   - トグルスイッチのスタイル

### 完了条件

- [x] `src/components/ui/SettingsScreen.ts`が実装されている
- [x] 設定画面が表示される
- [x] カメラON/OFFトグルが動作する
- [x] 顔表示ON/OFFトグルが動作する
- [x] 設定がlocalStorageに保存される
- [x] 設定が次回起動時に復元される
- [ ] 設定に応じてゲームの動作が変わる（Phase 6で実装予定）
- [x] タイトル画面から設定画面に遷移できる
- [x] 設定画面からタイトル画面に戻れる
- [x] TypeScriptコンパイルエラーがない
- [x] ビルドが成功する

### 検証方法

1. `pnpm run dev`でアプリを起動
2. タイトル画面で設定ボタンをクリック
3. 設定画面が表示される
4. カメラON/OFFトグルをクリックして切り替える
5. 顔表示ON/OFFトグルをクリックして切り替える
6. カメラOFF時は顔表示トグルが無効化される
7. 保存して戻るボタンでタイトル画面に戻る
8. 再度設定画面を開き、設定が保存されていることを確認
9. ゲームを開始して、設定が反映されていることを確認
10. ページをリロードして、設定が復元されることを確認

---

## Step 4.4: リザルト画面の実装

### 目的

ゲーム終了後にスコアを表示し、リプレイまたはタイトルに戻れるようにします。

### タスク詳細

1. **ResultScreenの実装**
   - `src/components/ui/ResultScreen.ts`を作成
   - 実装する機能:
     - `init()`: リザルト画面の作成
     - `show()`: 画面を表示
     - `hide()`: 画面を非表示
     - `setScore()`: スコア情報の設定
     - `dispose()`: クリーンアップ
   - UI要素:
     - タイトル「結果」
     - スコア表示（大きく目立つように）
     - 最大コンボ表示
     - 切った宝物の総数
     - リプレイボタン（セットアップ画面へ遷移）
     - タイトルに戻るボタン
   - スタイリング:
     - 中央配置
     - スコアを強調するデザイン
     - 華やかな演出

2. **GameStateManagerの更新**
   - `setState('result')`時の処理を追加
   - ResultScreenの表示
   - スコア情報の受け渡し
   - リプレイ/タイトルへの遷移処理

3. **ゲーム終了処理の実装**
   - タイマー終了時（Phase 5で実装予定）またはテスト用の手動終了
   - ゲームの停止:
     - トラッキングの停止
     - レンダリングループの停止
     - スコアデータの保存
   - リザルト画面への遷移

4. **main.tsの更新**
   - ゲーム終了時の処理を追加
   - スコアデータをGameStateManagerに渡す
   - リザルト画面への遷移

5. **CSSの追加**
   - リザルト画面専用スタイル
   - スコア表示のアニメーション（オプション）

### 完了条件

- [ ] `src/components/ui/ResultScreen.ts`が実装されている
- [ ] リザルト画面が表示される
- [ ] スコアが正しく表示される
- [ ] 最大コンボが表示される
- [ ] 切った宝物の総数が表示される
- [ ] リプレイボタンでセットアップ画面へ遷移する
- [ ] タイトルに戻るボタンでタイトル画面へ遷移する
- [ ] リプレイ時にスコアがリセットされる
- [ ] TypeScriptコンパイルエラーがない
- [ ] ビルドが成功する

### 検証方法

1. `pnpm run dev`でアプリを起動
2. ゲームを開始（セットアップ → playing）
3. いくつかロープを切ってスコアを獲得
4. テスト用の終了処理を実行（Phase 5でタイマー実装前）
5. リザルト画面が表示される
6. 獲得したスコアが表示される
7. 最大コンボが表示される
8. 切った宝物の総数が表示される
9. リプレイボタンをクリックすると、セットアップ画面に戻る
10. 再度ゲームを開始して、スコアがリセットされていることを確認
11. タイトルに戻るボタンでタイトル画面に戻る

---

## 技術メモ

### 状態遷移図

```
title → setup → playing → result
  ↓       ↓                    ↓
settings  ↑                  title
  ↓       ↓                    ↓
title   title                setup
```

### GameStateManagerの役割

- ゲーム全体の状態を管理（title, setup, settings, playing, result）
- 各画面の表示/非表示を制御
- 状態に応じてゲーム機能（カメラ、トラッキング、レンダリング）の開始/停止を制御
- 設定の永続化（localStorage）

### 設定の保存形式

```typescript
interface GameSettings {
  cameraEnabled: boolean;    // カメラON/OFF
  faceVisible: boolean;      // 顔表示ON/OFF（カメラON時のみ有効）
}

// localStorageキー: 'crab-game-settings'
```

### カメラOFF時の代替画像

Phase 6で実装予定ですが、Phase 4ではプレースホルダーとして単色背景を表示します。

### 画面間のデータ受け渡し

GameStateManagerがスコアデータや設定データを保持し、各画面に渡します。

### レスポンシブ対応

すべてのUI画面はスマートフォンでの表示を最優先にデザインします。

---

## Phase 4 完了後の状態

Phase 4完了後、ゲームの基本的なフローが完成します:

1. タイトル画面でスタートボタンをクリック
2. セットアップ画面でカメラとトラッキングを初期化
3. 自動的にゲーム画面に遷移
4. ジェスチャーでロープを切ってスコアを獲得
5. （テスト用の終了処理で）リザルト画面に遷移
6. リプレイまたはタイトルに戻る

次のPhase 5では、タイマーシステムと宝物の出現パターンを実装し、30秒間のゲームプレイを完成させます。
