# 新春カニカニパニック! - 実装計画書

## 実装方針

### 基本原則
1. **コンポーネントの分離**: 機能ごとにモジュールを適切に分割
2. **段階的実装**: 各ステップで動作するものを作り、徐々に機能を追加
3. **独立開発**: 各機能を独立して開発し、最後に統合

### アーキテクチャ

#### ディレクトリ構成（想定）
```
src/
├── components/
│   ├── camera/           # カメラ・トラッキング関連
│   │   ├── HandTracker.ts
│   │   ├── FaceTracker.ts
│   │   └── CameraView.ts
│   ├── game/             # ゲームロジック
│   │   ├── GameManager.ts
│   │   ├── Rope.ts
│   │   ├── Treasure.ts
│   │   └── Physics.ts
│   ├── renderer/         # 3D描画
│   │   ├── Scene.ts
│   │   ├── CrabHand.ts
│   │   └── Models.ts
│   └── ui/               # UI画面
│       ├── TitleScreen.ts
│       ├── SetupScreen.ts
│       ├── SettingsScreen.ts
│       └── ResultScreen.ts
├── utils/                # ユーティリティ
└── types/                # 型定義
```

## 実装ステップ

### Phase 1: カメラとトラッキング基盤

#### Step 1.1: プロジェクトセットアップ
- **タスク**:
  - Viteプロジェクトの初期化
  - TypeScript設定
  - 必要なパッケージのインストール
    - Three.js
    - Rapier
    - MediaPipe Hands
- **完了条件**:
  - 開発サーバーが起動し、空白ページが表示される

#### Step 1.2: カメラ入力の取得と表示
- **タスク**:
  - カメラアクセスの実装（`getUserMedia`）
  - カメラ映像の画面表示
  - エラーハンドリング（許可拒否時など）
- **完了条件**:
  - スマホでカメラ映像が画面に表示される

#### Step 1.3: ハンドトラッキングの実装
- **タスク**:
  - MediaPipe Handsの初期化
  - 手の検出とランドマーク取得
  - 手の位置にマーカー表示（デバッグ用）
  - `HandTracker.ts`として独立したモジュール化
- **完了条件**:
  - カメラ映像上に手のランドマークが表示される
  - 両手が正しく認識される

#### Step 1.4: フェイストラッキングの実装
- **タスク**:
  - MediaPipe Face Detectionの初期化
  - 顔の検出と位置取得
  - 顔の位置にマーカー表示（デバッグ用）
  - `FaceTracker.ts`として独立したモジュール化
- **完了条件**:
  - カメラ映像上に顔の位置がマーカー表示される

### Phase 2: ゲームコア機能

#### Step 2.1: Three.jsシーンのセットアップ
- **タスク**:
  - Three.jsシーンの初期化
  - カメラ、ライトの設定
  - レンダリングループの実装
  - 簡単なテストオブジェクトの表示
- **完了条件**:
  - 3Dオブジェクトが画面に表示される

#### Step 2.2: Rapier物理エンジンの統合
- **タスク**:
  - Rapierの初期化
  - 物理ワールドの作成
  - 簡単な物理オブジェクトのテスト（落下するボールなど）
- **完了条件**:
  - 物理演算が正しく動作する

#### Step 2.3: ロープと宝物の実装
- **タスク**:
  - ロープの物理演算実装（Rapierで複数の剛体をジョイント接続）
  - 宝物オブジェクトの作成
  - ロープに宝物を吊るす
  - 画面左右からロープ付き宝物が移動するロジック
- **完了条件**:
  - ロープに吊られた宝物が画面を横切る
  - ロープが物理的に揺れる

#### Step 2.4: クリックによるロープ切断
- **タスク**:
  - クリック位置の取得
  - ロープとの当たり判定
  - ロープの切断処理（ジョイント削除）
  - 宝物の落下
- **完了条件**:
  - クリックでロープが切れて宝物が落下する

#### Step 2.5: スコアシステムの実装
- **タスク**:
  - スコアカウンターの実装
  - 宝物落下時のスコア加算
  - スコア表示UI
  - コンボシステムの基礎実装
- **完了条件**:
  - ロープを切るとスコアが加算され表示される

### Phase 3: ジェスチャー操作の統合

#### Step 3.1: ジェスチャー認識の実装
- **タスク**:
  - ピースサイン（Vサイン）の検出ロジック
    - 人差し指と中指が伸びている
    - 他の指が曲がっている
  - V閉じ動作の検出ロジック
    - ピース状態から全指が曲がる
  - 左右の手を独立して認識
- **完了条件**:
  - ジェスチャーが正しく認識され、コンソールに出力される

#### Step 3.2: 手の3Dモデル表示
- **タスク**:
  - カニの手3Dモデルの読み込み（開・閉）
  - トラッキングした手の位置に3Dモデルを配置
  - ジェスチャーに応じたモデル切り替え
  - 2D座標から3D座標への変換
- **完了条件**:
  - 手の位置にカニの手モデルが表示される
  - ジェスチャーに応じてモデルが変化する

#### Step 3.3: ジェスチャーでのロープ切断
- **タスク**:
  - V閉じ動作時の当たり判定発生
  - 手の位置とロープの当たり判定
  - クリック処理をジェスチャー処理に置き換え
- **完了条件**:
  - ジェスチャーでロープが切断できる

### Phase 4: UI画面の実装

#### Step 4.1: タイトル画面
- **タスク**:
  - タイトル表示
  - カメラ許可に関する注意事項表示
  - スタートボタン
  - 画面遷移の実装
- **完了条件**:
  - タイトル画面が表示され、スタートボタンで次へ進める

#### Step 4.2: セットアップ画面
- **タスク**:
  - 注意事項の表示
  - トラッキング初期化の待機
  - トラッキング成功時の自動遷移
- **完了条件**:
  - セットアップ画面が表示され、トラッキング成功でゲーム開始

#### Step 4.3: 設定画面
- **タスク**:
  - カメラON/OFFトグル
  - 顔表示ON/OFFトグル（カメラON時のみ）
  - 設定の保存と適用
  - 設定画面へのアクセス（タイトル or セットアップから）
- **完了条件**:
  - 設定が正しく保存・反映される

#### Step 4.4: リザルト画面
- **タスク**:
  - スコア表示
  - リプレイボタン
  - タイトルに戻るボタン
  - ゲーム終了時の自動遷移
- **完了条件**:
  - ゲーム終了後にリザルト画面が表示される
  - 各ボタンで正しく遷移する

### Phase 5: ゲームロジックの完成

#### Step 5.1: タイマーシステム
- **タスク**:
  - 30秒のカウントダウン実装
  - タイマー表示UI
  - 時間切れ時の処理
- **完了条件**:
  - 30秒でゲームが終了しリザルト画面へ遷移

#### Step 5.2: 宝物の出現パターン
- **タスク**:
  - 定期的な宝物の出現
  - 左右からのランダム出現
  - 時間経過による出現頻度の上昇
  - 移動速度の調整
- **完了条件**:
  - 30秒間、適切なペースで宝物が出現し続ける

#### Step 5.3: 難易度調整
- **タスク**:
  - 宝物の速度カーブの調整
  - 当たり判定サイズの調整
  - ジェスチャー認識の閾値調整
  - テストプレイによるバランス調整
- **完了条件**:
  - ゲームが適度な難易度でプレイできる

### Phase 6: ビジュアル・演出の実装

#### Step 6.1: カメラ表示の統合
- **タスク**:
  - カメラ映像を3D空間の背景に配置
  - カメラOFF時のキャラクター画像表示
  - 設定に応じた切り替え
- **完了条件**:
  - 設定に応じて背景が正しく表示される

#### Step 6.2: 顔モデルの統合
- **タスク**:
  - キャラクター顔3Dモデルの読み込み
  - フェイストラッキング位置への配置
  - 顔表示設定に応じた表示/非表示
- **完了条件**:
  - 顔OFF設定時にキャラクター顔が表示される

#### Step 6.3: 宝物の3Dモデル
- **タスク**:
  - 複数種類の宝物3Dモデルの作成または読み込み
  - モデルの配置と表示
  - 種類によるスコア差の実装
- **完了条件**:
  - 複数種類の宝物が表示され、種類ごとに得点が異なる

#### Step 6.4: エフェクトと演出
- **タスク**:
  - ロープ切断時のエフェクト
  - スコア加算時のアニメーション
  - コンボ時の演出
  - サウンドエフェクト（必要に応じて）
- **完了条件**:
  - ゲームが視覚的に楽しくなる

### Phase 7: 最終調整

#### Step 7.1: パフォーマンス最適化
- **タスク**:
  - フレームレートの測定と改善
  - 不要なオブジェクトの削除
  - 物理演算の最適化
- **完了条件**:
  - スマホでスムーズに動作する（目標: 30fps以上）

#### Step 7.2: バグフィックスとテスト
- **タスク**:
  - 各画面遷移のテスト
  - エッジケースの確認
  - 複数デバイスでのテスト
- **完了条件**:
  - 致命的なバグがない

#### Step 7.3: UI/UXの最終調整
- **タスク**:
  - フォント、色、レイアウトの調整
  - レスポンシブ対応の確認
  - タッチ操作の最適化
- **完了条件**:
  - ゲームが直感的に操作できる

## マイルストーン

| Phase | 完了目標 | 説明 |
|-------|---------|------|
| Phase 1 | カメラとトラッキングが動作 | 手と顔にマーカーが表示される |
| Phase 2 | ゲームコアが動作 | クリックでロープを切れる |
| Phase 3 | ジェスチャー操作が動作 | ジェスチャーでロープを切れる |
| Phase 4 | 全画面が揃う | ゲームフロー全体が繋がる |
| Phase 5 | ゲームとして完成 | 30秒プレイできる |
| Phase 6 | ビジュアル完成 | 見た目が整う |
| Phase 7 | リリース可能 | 安定動作する |

## リスクと対策

### 技術的リスク
- **MediaPipeの動作が重い**
  - 対策: 検出頻度の調整、モデルの軽量化
- **Rapierの物理演算が不安定**
  - 対策: パラメータ調整、シンプルな実装に変更
- **デバイスによる動作差**
  - 対策: 複数デバイスでの早期テスト

### スケジュールリスク
- **機能が多すぎる**
  - 対策: Phase単位で動作するものを作る
  - 各Phaseで中断しても動くものを残す

## 開発時の注意事項

1. **トラッキング部分は完全に分離**: 他のコンポーネントから独立させる
2. **2D/3D座標変換は慎重に**: カメラ座標、スクリーン座標、ワールド座標の変換を明確に
3. **物理演算のパラメータは調整可能に**: 定数をまとめて管理
4. **デバッグモード**: マーカー表示などのデバッグ機能を残しておく
5. **設定の永続化**: localStorageなどで設定を保存
